version: '3.8'

services:
  # PostgreSQL database for SQL checks
  postgres:
    image: postgres:16-alpine
    container_name: pmp-test-postgres
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: testdb
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d testdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for NoSQL checks
  redis:
    image: redis:7-alpine
    container_name: pmp-test-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HTTPBin for HTTP API checks
  httpbin:
    image: kennethreitz/httpbin
    container_name: pmp-test-httpbin
    ports:
      - "8081:80"

  # PMP Test API Application
  app:
    profiles:
      - app
      - integration-tests
    build:
      context: .
      dockerfile: Dockerfile
    # Alternatively, use the published image:
    # image: ironedge/pmp-test-api:latest
    container_name: pmp-test-api
    ports:
      - "8080:8080"
    environment:
      # Server configuration
      PORT: 8080
      RUST_LOG: "info,pmp_test_api=debug"

      # SQL Database Check - PostgreSQL
      SQL_TESTDB_DRIVER: postgres
      SQL_TESTDB_HOST: postgres
      SQL_TESTDB_PORT: 5432
      SQL_TESTDB_USER: testuser
      SQL_TESTDB_PASSWORD: testpass
      SQL_TESTDB_DATABASE: testdb

      # NoSQL Database Check - Redis
      NOSQL_TESTREDIS_DRIVER: redis
      NOSQL_TESTREDIS_HOST: redis
      NOSQL_TESTREDIS_PORT: 6379

      # HTTP API Checks - HTTPBin
      HTTP_TESTAPI_URL: http://httpbin/status/200
      HTTP_TESTAPI_METHOD: GET
      HTTP_TESTAPI_HEADERS: "{}"

      HTTP_TESTAPI2_URL: http://httpbin/headers
      HTTP_TESTAPI2_METHOD: GET
      HTTP_TESTAPI2_HEADERS: '{"User-Agent":"pmp-test-api/0.1.0","X-Custom-Header":"test-value"}'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      httpbin:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/_/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Hurl Integration Tests
  hurl:
    profiles:
      - integration-tests
    image: orangeopensource/hurl:1.8.0
    container_name: pmp-test-hurl
    volumes:
      - ./resources/integration-tests:/tests:ro
    depends_on:
      app:
        condition: service_healthy
    command: --test --glob "/tests/**/*.hurl"
